---
title: 第十章-系统串行扩展
toc: true
math: true
---

# 单总线串行扩展

- **单总线**（也称*1-Wire bus*）由美国DALLAS公司推出的外围串行扩展总线。只有一条数据输入/输出线DQ，总线上所有器件都挂在DQ上，**电源也通过这条信号线供给**
- <img src="http://222.65.137.121:9702/images/2020/12/02/20201203095035.png" alt="image-20201203095035346" style="zoom:50%;" />

## 单总线扩展的典型应用-DS18B20的温度测量系统

1. 单总线温度传感器DS18B20简介

   - 可直接将温度转化成数字信号传送给单片机处理，因而可省去传统的信号放大、A/D转换等外围电路

   - 测量温度范围-55～+128℃，在-10～+ 85℃范围内，测量精度可达±0.5℃，非常适合于恶劣环境的现场温度测量，也可用于各种狭小空间内设备的测温

   - <img src="http://222.65.137.121:9702/images/2020/12/02/20201203095152.png" alt="image-20201203095152896" style="zoom:50%;" />

   - 片内有9个字节的高速暂存器RAM单元，9个字节具体分布如下：

     - ![image-20201203095251301](http://222.65.137.121:9702/images/2020/12/02/20201203095251.png)
     - **第1字节**和**第2字节**是在单片机发给DS18B20温度转换命令发布后，经转换所得的温度值，以两字节补码形式存放其中。一般情况下，用户多使用第1字节和第2字节。单片机通过单总线可读得该数据，读取时低位在前，高位在后
     - **第3、4字节**分别是由软件写入用户报警的上下限值TH和TL
     - **第5个字节**为配置寄存器，可对其更改DS18B20的测温分辨率
     - **第6、7、8字节**未用，为全1
     - **第9字节**是前面所有8个字节的CRC码，用来保证正确通信。片内还有1个E2PROM为TH、TL以及配置寄存器的映像

   - 配置寄存器的各位定义如下

     - ![image-20201203095422498](http://222.65.137.121:9702/images/2020/12/02/20201203095422.png)

     - 其中，TM位出厂时已被写入0，用户不能改变；低5位都为1；R1和R0用来设置分辨率。[表10-1](#b10-1)列出了R1、R0与分辨率和转换时间的关系。用户可通过**修改R1、R0位的编码，获得合适的分辨率**

     - | R1<a name="b10-1"> </a> | R0   | 分辨率/位 | 最大转换时间/ms |
       | ----------------------- | ---- | --------- | --------------- |
       |                         | 0    | 9         | 93.75           |
       | 0                       | 1    | 10        | 187.5           |
       | 1                       | 0    | 11        | 375             |
       | 1                       | 1    | 12        | 750             |

       **转换时间与分辨率有关**。当设定为9位时，转换时间为93.75ms；设定10位时，转换时间为187.5 ms；当设定11位时，转换时间为375ms；当设定为12位时，转换时间为750ms

   - 表10-2列出了DS18B20温度转换后所得到的16位转换结果的典型值。

     - ![image-20201203095726896](http://222.65.137.121:9702/images/2020/12/02/20201203095726.png)

   - 温度转换的计算方法

     - 当DS18B20采集的温度为+125℃时，输出为0x07d0，则：
       $$
       实际温度=(0x07d0)/16=(0\times 16^3+7\times 16^2+13\times 16^1+0\times 16^0)/16=125℃
       $$

     - 当DS18B20采集的温度为-55℃时，输出为0xfc90，由于是补码，则先将11位数据取反加1得0x0370，注意符号位不变，也不参加运算，则：
       $$
       实际温度=(0x0370)/16=(0\times 16^3+3\times 16^2+7\times 16^1+0 \times 16^0)/16=55℃
       $$

       > 注意：负号则需对采集的温度进行判断后，再予以显示

2. DS18B20的工作时序

   DS18B20对工作时序要求严格，延时时间需准确，否则容易出错。DS18B20的工作时序包括**初始化时序**、**写时序**和**读时序**。

   - **初始化时序**：单片机将**数据线DQ电平拉低**480\~960µs后释放，等待15\~60µs，单总线器件即可输出一持续60\~240µs的低电平，单片机收到此应答后即可进行操作
   - **写时序**：当单片机将数据线DQ电平从高拉到低时，产生写时序，有写“0”和写“1”两种时序。写时序开始后，DS18B20在15~60µs期间从数据线上采样。如果采样到低电平，则向DS18B20写的是“0”；如果采样到高电平，则向DS18B20写的是“1”。这两个独立的时序间至少需要拉高总线电平1µs的时间