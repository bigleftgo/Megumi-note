---
title: 实习2021.01.14
toc: true
math: true
---

# 计划表

- 第一周（1.18-22)
  - 熟悉PLC编程软件、基本操作。以西门子为例
  - 西门子s7-1200PLC编程基本方法
- 第二周(1.25-29)
  - 熟悉上位机软件blossimView
- 第三周（2.1-5)
  - 西门子和上位机联合调试

# S7-300.400PLC应用技术

- 定义：可编程序控制器是一种数字运算的电子系统，专为在工业环境下应用而设计。它采用可编程序的存储器，用来在其内部存储执行逻辑运算、顺序控制、定时、计数和算术运算等操作的指令，并通过数字式、模拟式的输入和输出，控制各种类型的机械或生产过程

## 基本结构

- cpu模块：微处理器+存储器
- 信号模块（SM）：数字量（AI、AO）、模拟量（DI、DO）
- 功能模块（fm）：增强PLC功能，如：高速计数、位置控制、闭环控制
- 接口模块（IM）：用于实现中央机架（CPU所在位置）和扩展机架通信
- 通信处理器（CP）：用于实现与其他设备通信
- 电源模块（PS）：转换输入电压为PLC工作电压（AC220V→DC24/5V）
- 编程设备：编程软件STEP7

## 工作原理

- 逻辑运算：触点串联实现“与”运算，并联实现“或”运算，用常闭触点控制线圈可以实现“非”运算

- 循环处理过程

  - ```mermaid
    graph TD
    A[执行OB100]-->B
    B[操作系统启动循环时间监控] --> C[CPU将过程映像输出区的数据写到输出模块]
    C --> D[CPU读取输入模块的输入状态,并存入过程映像输入区]
    D-->E[CPU处理用户程序,执行用户程序中的指令]
    E-->F[操作系统执行其他任务]
    F-->G[CPU返回第一阶段,重新启动循环时间监控]
    G-->B
    ```

  - 在启动完成后，每次循环都要调用一次组织块OB1，它是用户程序中的主程序，可以调用其他逻辑块（FB、FC、SFB或SFC）

- 系统结构：紧凑、无槽位限制，安装在DIM标准的导轨上，用背板总线连接除电源模块外的其他模块
  - ![](http://222.65.137.121:9702/images/2021/01/15/20210115110605.png)
  - 每个机架上安装的信号模块、功能模块和通信处理器除了不能超过8块以外，还受到背板总线DC 5V供电电流的限制

## S7-300的CPU模块的和电源模块

- CPU模块的元件
  - 状态与故障显示LED
    1. SF：系统错误/故障显示，红色
    2. BF：总线错误，红色
    3. DC 5V：+5V电源指示，绿色
    4. FRCE：强制，黄色
    5. RUN：运行模式，绿色（启动期间2Hz，保持状态5Hz）
    6. STOP：停止模式，黄色（STOP、HOLD状态常量，请求存储器复位时0.5Hz闪动，正在执行存储器复位时2Hz闪动）
    7. LINK LED：表示PROFINET接口的链接处于激活状态
    8. RX/TX LED：表示PROFINET接口正在接受/发送数据
- CPU的操作模式
  1. STOP：不执行用户程序，可以接收全局数据和检查系统
  2. RUN：执行用户程序，刷新输入和输出，处理中断和故障信息服务
  3. HOLD：在启动和RUN模式执行程序时遇到调试用的断点，用户程序的执行被挂起，定时器被冻结
  4. STARTUP：可以用模式选择开关或者STEP7启动CPU
- 模式选择开关：
  1. RUN：CPU执行用户程序
  2. STOP：CPU不执行用户程序
  3. MRES（复位存储器）：MERS位置不能保持，可以复位存储器，使CPU回复初始状态
- 通信接口：MPI（多点接口）、DP接口、点对点接口，带有PN的型号还有一个PROFINET工业以太网接口

## 编程软件STEP7的安装与使用

- 功能：
  - 组态硬件：为模块分配地址和设置模块的参数
  - 组态通信连接：定义通信伙伴和连接特性
  - 使用编程软件编写用户程序
  - 下载和调试用户程序、启动、维护、文件建档、运行和故障诊断等功能

### 使用方法

- 用新建项目向导创建项目
  - 在对话框中选择需要生成的组织块OB，默认只生成OB1。默认的编程语言为语句表（STL），可以用单选框将它修改为梯形图（LAD）
  - 在项目名称文本框中修改项目名称，最多允许八个字符
  - 缺点在于同一型号的CPU只能选用一种订货号
- 直接创建项目
  - 执行菜单命令“文件”→“新建”
  - 创建完成后，在管理器中右键新项目的图标，用出现的快捷菜单中的命令插入一个新的S300/400站
  - 选中生成的站，双击右边窗口中的“硬件”图标，在硬件组态工具HW Config中，双击S7-400的机架（Rack）或S7-300的导轨（Rail），生成一个机架
  - 将CPU模块、电源模块和信号模块插入机架

## 项目的分层结构

- 第一层为项目，第二层为站（组态硬件的起点），第三层为CPU，第四层“S7程序”文件夹是编写程序的起点，所有软件均存放在该文件夹中
  - 项目：站、网络对象
  - 站：硬件、CPU和CP（通信处理器）
  - CPU：包含S7程序和连接
  - S7程序：包含源文件、块和符号表，生成程序时自动生成一个空的符号表
  - 块对象：逻辑块（OB、FB、FC、SFB、SFC）、数据块（DB）、用户定义的数据类型（UDT）、系统数据和调试程序用的变量表（VAT）

## 项目属性设置

- 语言设置：菜单命令“选项”→“自定义”中的语言选项卡中选择
- 存储位置：“常规”选项卡中修改

## STEP7和PLC通信连接的组态

- 硬件：PC/MPI适配器，USB/MPI适配器，PCI总线卡
- 在STEP7的SIMATIC管理器中执行菜单命令“选项”→设置PG/PC接口，打开对话框，在中间的列表中选择实际使用的通信硬件的和通信协议

## 硬件组态概述

- 系统组态：从硬件目录中选择机架，将模块分配给机架中的插槽。
- CPU的参数设置：设置CPU模块的多种属性，设置的数据存储在CPU的系统数据中
- 模块的参数设置：定义模块所有的可调整参数

### 多机架系统的组态

- 一个S7-300站最多可以有4个机架，0号机架是主机架，1\~3号机架是扩展机架

### I/O模块的地址分配

- S7-300的数字量（或称开关量）I/O点地址由地址标识符、地址的直接部分和位部分组成，一个字节由0~7这8位组成。地址标识符==I==表示输入，==Q==表示输出，==M==表示位存储器。

  > 例如==I3.2==：小数点前的3是地址的字节部分，小数点后面的2表示它是字节中的第2位。==I3.0\~I3.7==组成一个输入字节==IB3==

- 数字量模块的起始字节地址：
  $$
  32\times M + (N-4)\times 4
  $$
  范围：M（0\~3）N（4\~11）

- 模拟量模块起始字节地址：
  $$
  128\times M+(N-4)\times 16 +256
  $$
  范围：IB256\~767

## 输入、输出模块

### 数字量输入模块

- 直流输入电路的延迟时间较短，可以直接与接近开关、光电开关等电子输入装置连接，DC 24V适用于PLC处在的物理环境较好，信号线不是很长的情况下
- ![image-20210115110509030](http://222.65.137.121:9702/images/2021/01/15/20210115110509.png)
- 双击数字量输入模块即可打开参数设置窗口

### 数字量输出模块

- 输出电流的额定值为0.5\~8A（与模块型号有关），负载电源由外部现场提供
- ![image-20210115111326097](http://222.65.137.121:9702/images/2021/01/15/20210115111326.png)
- ![image-20210115111403857](http://222.65.137.121:9702/images/2021/01/15/20210115111403.png)
  - 继电器输出模块的负载电压范围宽，导通压降小，承受瞬时过电压和瞬时过电流的能力较强，但是动作速度较慢，寿命有一定的限制
  - 固态继电器型输出模块只能用于交流负载。
  - 晶体管型、场效应晶体管型输出模块只能用于直流负载，它们的可靠性高，响应速度快，寿命长，但是过载能力较差
- 在选择数字量输出模块时，应注意负载电压的种类和大小、工作频率和负载的类型。除了每一点的输出电流外，还应注意每一组的最大输出电流

### 模拟量输入模块

- 模拟量变送器：
  - 用于将传感器提供的电量或非电量转换为标准量程的直流电流或直流电压信号，例如：DC 0\~10V和DC 4\~20mA
- SM331模拟量输入模块的基本结构
  - 主要结构：积分式A/D转换器
  - ![image-20210115112455218](http://222.65.137.121:9702/images/2021/01/15/20210115112455.png)

### 模拟量输出模块

- 响应时间t<sub>A</sub>是指内部存储器得到数字量输出值到模拟量输出达到指定值的时间，在最坏的情况下，该时间为循环时间t<sub>Z</sub>与建立时间t<sub>E</sub>之和
- 组态：模拟量输出模块无外部负载电压，有组态/编程错误，对M点短路或者断线时，将诊断消息写入模拟量模块的诊断缓冲区，然后送入CPU。如果启用了“诊断中断”，将触发一个诊断中断，并调用OB82.可以设置各通道是否允许组诊断

## 功能模块

1. **计数器模块**：为32位或±31位加减计数器，可以判断脉冲的方向。有比较功能，达到比较值时，通过集成的数字量输出响应信号，或通过背板总线向CPU发出中断。
2. **位置控制与位置检测模块**：定位模块可以用编码器来测量位置，并向编码器供电。定位模块的定位功能独立于用户程序
3. **闭环控制模块**：自优化控制算法，PID算法以及模糊控制器
4. **称重模块**：SIWAREX U是紧凑型电子秤，使用RS-232C接口连接计算机；SIWAREX M是有校验能力的电子秤重和配料单元，可以安装在易爆区域，还可以作为独立于PLC的现场仪器使用
5. **S5智能I/O模块**：包含计数器模块、温度控制模块、位置解码器模块、定位、位置测量和计数器模块、凸轮控制器模块、A,B,C定位模块。其优点是能够完全独立地执行实时任务，减轻了CPU的负担

## STEP7的编程语言

1. **顺序功能图（SFC）**：是一种位于其他编程语言之上的图形语言，工艺过程被划分为若干个顺序出现的步，步包含控制输出的动作，从一步到另一步的转换由转换条件控制
2. **梯形图（LAD）**：是使用的最多的PLC图形编程语言。梯形图与继电器电路图很相似，具有直观易懂的优点，特别适合于数字量逻辑控制。
   - 由触点、线圈和方框表示的指令框组成。触点表示逻辑输入条件，线圈表示逻辑运算结果，指令框用于表示定时器、计数器或数学运算等附加指令
3. **语句表（STL）**：是一种类似于微机的汇编语言的文本语言，多条指令组成一个程序段。可以实现某些不能用梯形图或者功能块图表示的功能
4. **功能块图（FBD）**：使用类似于布尔代数的图形逻辑符号来表示控制逻辑
5. **结构文本（ST）**：专用高级编程语言，能够实现复杂数学运算，程序简洁紧凑
6. **S7-HiGraph编程语言**：用状态图来描述异步、非顺序的过程
7. **CFC编程语言**：用图形方式连接程序库中以块的形式提供的各种功能，包括从简单的逻辑操作到复杂的闭环和开环控制
8. **编程语言的相互转换与选用**：组织块OB、功能块FB、功能FC、系统功能块SFB和系统功能SFC统称为逻辑块。在STEP7软件中，如果逻辑块没有错误，并且被正确地划分为程序段，梯形图、功能块图和语句表可以相互转换

### 生成用户程序

- 用“新建项目”向导生成一个名为“电机控制”的项目，CPU可以选用任意型号。
- 在程序中可以用绝对地址访问变量，但是符号地址使得程序更容易阅读和理解
  - 共享符号：在符号表和共享数据块中定义，它们可以被所有的逻辑块使用
  - 局部符号：在逻辑块的变量声明表中定义，只在定义它的块中有效
- 定义符号地址：选中SIMATIC管理器左边窗口的“S7程序”，双击右边窗口出现的“符号”，打开符号编辑器
  - 单击某一列的表头，可以改变排序的方法
- 生成梯形图程序：选中 SIMATIC管理器左边窗口中的“块”，双击右边窗口中的OB1，打开程序编辑器。在第一次打开时，逻辑块与每个程序段均有灰色背景的注释区（用菜单命令“视图“→”显示方法“→”注释“关闭注释区）

## 基本数据类型

- 位：数据类型为布尔型，1和0分别用true和false表示

  - 地址由字节地址和位地址组成，称为”字节.位“寻址方式

- 字节：由8个位数据组成

- 字和双字：相邻的两个字节组成一个字（word），相邻的两个字组成一个双字（Doube Word）。字和双字都是无符号数，用16进制表示。

  > 例：==MW100==是由MB100\~MB103组成的一个字，M为区域标识符，W表示字。==MD100==D表示双字

  - 以组成字MW100和双字MD100的编号最小的字节MB100的编号作为它们的编号
  - 组成MW100和MD100的编号最小的字节MB100位MW100和MD100的最高位字节，编号最大的字节为字和双字的最低位字节
  - 数据类型字节、字和双字都是无符号数，它们的数字由16进制表示

### 16位整数和32位双整数

- 16位整数（INT）和32位双整数（DINT）是有符号数，用二进制数补码表示，其最高位为符号位，0为正，1为负

### 32位浮点数

- 实数（REAL）又称浮点数，可以表示为1.m×2<sup>E</sup>，尾数中的m和指数E均为二进制数
- 优点：用很小的存储空间（4B）可以表示非常大和非常小的数

### ASCII码字符

- 用7位二进制数来表示所有的英语大写、小写、数字0-9、标点符号以及特殊控制字符

### 常数的表示方法

- 常数值可以是字节、字或双字，CPU以二进制方式来存储常数

  - B#16#、W#16#、DW#16#分别用来表示十六进制字节、字和双字常数

  - 2#用来表示二进制常数<font color='grey'>2#1101_1010</font>

  - L#用来表示32位双整数常数<font color='grey'>L# +5</font>

  - P#用来表示地址指针常数<font color='grey'>P#M2.0是M2.0的地址</font>

  - S5T#用来表示16位S5时间常数<font color='grey'>aH_bbM_ccS_dddMS</font>

    > 其中a、bb、cc和ddd分别是小时、分、秒和毫秒的值，取值范围为S5T#0S\~S5T#9990S

  - T#用来表示带符号的32位IEC时间常数<font color='grey'>T#1D_12H_30M_0S_250MS（增量1ms）</font>

  - DATE是IEC时间常数<font color='grey'>D#2004-1-15</font>

  - C#用来表示16位计数器常数（BCD码）<font color='grey'>C#250</font>

  - ASCII字符用单引号表示<font color>'A2C'</font>

## 功能块

- 局部变量：
  - IN：输入参数，用于将数据从调用块传送到被调用块
  - OUT：输出参数，用于将块的执行结果从被调用块返回给调用它的块
  - IN_OUT：输入_输出参数，参数的初值由调用它的块提供，块执行后由同一个参数将执行结果返回给调用它的块
  - TEMP：临时变量，暂时保存在局部数据区中的变量
  - STAT：静态变量，从功能块执行完，到下一次重新调用它，静态变量的值保持不变

## 系统存储器

1. 过程映像输入/输出（I/Q）
   - CPU并不直接访问I/O模块中的输入地址区和输出地址区，而是访问CPU内部的过程映像区。在每次扫描循环开始时，CPU读取输入模块的外部输入电路的状态，并将它们存入过程映像输入表（PII）
   - <img src="http://222.65.137.121:9702/images/2021/01/15/20210115143350.png" alt="image-20210115143350697" style="zoom:50%;" />
   - 过程映像和中断功能配合，可以显著地减少PLC的输入、输出响应时间
2. 外设I/O区（PI/PQ）
   - 其允许直接访问本地的和分布式的输入模块和输出模块
3. 内部存储器标志位（M）存储器区
   - 内部存储器标志位用来保存控制逻辑的中间操作状态或其他控制信息
4. 定时器（T）存储器区
   - 定时器相当于继电器系统的时间继电器，剩余时间值可以用二进制或BCD码方式读取
5. 计数器（C）存储器区
   - 计数器用来累计其计数脉冲的个数，给计数器分配的字用于存储计数当前值
6. 数据块（DB）与背景数据块（DI）
7. 局部数据区
   - 各逻辑块都有它的局部（Local）数据区，局部变量在逻辑块的变量声明表中生成，只能在它被创建的块中使用。

## CPU中的寄存器

1. **累加器（ACCUx）**：32位累加器是用于处理字节、字或双字的寄存器，是执行语句表指令的关键部件

2. **地址寄存器**：两个32位的地址寄存器AR1和AR2作为地址指针，用于寄存器间接寻址

3. **数据块寄存器**：32位数据块寄存器DB和DI的高16位分别用来保存打开的共享数据块和背景数据块的编号，低16位用来保存打开的数据块的字节长度

4. **状态字**：是一个16位的寄存器，用于存储CPU执行指令后的状态或结果，以及出现的错误

   ![image-20210115144150999](http://222.65.137.121:9702/images/2021/01/15/20210115144151.png)

## STEP7在编程和调试中的应用

### 符号表

1. **特殊对象属性**：执行菜单命令”视图“→”列R、O、M、C、CC“可以在符号表中显示或关闭这些列。分别是监视属性，使用WinCC进行操作员监控、消息属性、通信属性和在接触点上控制。
2. **符号地址与绝对地址的优先级**：指在改变符号表中的符号、改变共享数据块中的变量或逻辑块的局部变量的名称时，是绝对地址有限还是符号地址优先。
3. **编程时输入单个符号**：在程序中用鼠标右键点击使用绝对地址的某个元件，执行出现的快捷菜单中的”编辑符号“命令，在出现的符号编辑对话框中输入新符号的信息，新的符号会自动添加到总的符号表中
4. **过滤器（Filter）**：用菜单命令”视图“→”过滤“打开过滤器对话框，可以有选择地只显示部分符号
   - 按符号名称、地址、数据类型和注释进行过滤
   - 根据属性过滤符号
   - 用复选框”有效“和”无效“来选择只显示有效的符号或无效的符号
5. **导入和导出符号表**：执行菜单命令”符号表“→”导出“，可以导出符号表或导出选择的若干行符号，将它们存入文本文件，用文本编辑器进行编辑

### 程序编辑器

1. 逻辑块的组成：由变量声明表、程序指令和属性组成
2. 选择输入程序的方式：
   - **增量编辑器**：适用于梯形图、功能块图、语句表和S7-HiGraph编程语言，适用于初学者
   - **源代码（文本）编辑器**：适用于语句表、S7-SCL、S7-HiGraph编程语言，用源文件（文本文件）的形式生成和编辑用户程序，再将该文件编译成各种块。适用于水平较高的程序员使用
   - **将已生成的块转换为源文件**：打开某个块，执行菜单命令”文件“→”生成源文件“，在出现的”新建“对话框中，可以输入源文件的名称，改变保存原文件的文件夹。点击“确定”按钮，在出现的“生成源文件“对话框中选择要转换为源文件的块
   - **将源文件编译成块**：用右键点击要编译的源文件，执行出现的快捷菜单中的”编译“命令
3. 选择编程语言：可以用”视图“菜单中的命令选择3中基本编程语言：LAD、STL和FBD
4. 生成逻辑块：在SIMATIC管理器中执行菜单命令”插入“→”S7块“，生成逻辑块。双击某个块，将打开程序编辑器
5. 网络：程序被划分为若干个网络，STEP7将其翻译为”程序段“

### 变量表

1. 变量表的功能
   - 监视变量：显示用户程序或CPU中每个变量的当前值
   - 修改变量：将固定值赋给用户程序或CPU中的变量
   - 对外输出赋值：允许在停机状态下将固定值赋给CPU的每一个输出点Q
   - 强制变量：给某个变量赋予一个固定值，用户程序的执行不会影响被强制的变量的值
   - 定义变量被监视或赋予新值的触发点和触发条件
2. 变量表的生成：在SIMATIC管理器中执行菜单命令”插入“→”S7块“→”变量表“，生成新的变量表
3. 在变量表中输入变量
4. 监视变量
5. 修改变量
6. 定义变量表的触发方式
7. 变量表应用举例
8. 强制变量

## 用户程序的基本结构

| 块                | 简要描述                                                     |
| ----------------- | ------------------------------------------------------------ |
| 组织块（OB）      | 操作系统与用户程序的接口，决定用户程序的结构                 |
| 功能块（FB）      | 用户编写的包含经常使用的功能的子程序，有专用的存储区（即背景数据块） |
| 功能（FC）        | 用户编写的包含经常使用的功能的子程序，没有专用的存储区       |
| 系统功能块（SFB） | 集成在CPU模块中，通过SFB调用系统功能，有专用的存储区（即背景数据块） |
| 系统功能（SFC）   | 集成在CPU模块中，通过SFC调用系统功能，无专用的存储区         |
| 共享数据块（DB）  | 存储用户数据的数据区域，供所有的逻辑块共享                   |
| 背景数据块（DI）  | 用于保存FB和SFB的输入、输出参数和静态变量，其数据在编译时自动生成 |



### 电机模拟

- 启动按钮、停止按钮（输入DI）
- MCC准备信号、Running运行反馈信号
- 输出Start启动信号
- 要求：实现按钮启停电机、实现画面操作、画面监视状态
